name: Quality Check (Morning & Evening)

on:
  schedule:
    - cron: '0 0 * * *'   # åˆå‰9æ™‚ JST (UTC 0:00)
    - cron: '0 12 * * *'  # åˆå¾Œ9æ™‚ JST (UTC 12:00)
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job to run'
        required: false
        type: choice
        options:
          - 'all'
          - 'morning'
          - 'evening'
        default: 'all'
  pull_request:
    paths:
      - 'frontend/**'
      - 'airflow/**'
      - 'scripts/**'

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write

concurrency:
  group: quality-check-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ====================================================================
  # æœ: Lighthouse Performance Report
  # ====================================================================
  morning-lighthouse:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 0 * * *') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_type == 'morning' || github.event.inputs.job_type == 'all')) ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: Morning Quality Check (Lighthouse)

    outputs:
      date: ${{ steps.date.outputs.date }}

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        working-directory: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        id: type-check
        continue-on-error: true
        run: |
          npm run type-check 2>&1 | tee type-check.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run linting
        id: lint
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
          fi

      - name: Build production bundle
        run: npm run build

      - name: Verify build output
        run: |
          echo "=== Build output structure ==="
          ls -la dist/

          if [ -d "dist/dist" ]; then
            echo "ERROR: Nested dist/dist/ detected"
            exit 1
          fi

          if [ ! -f "dist/index.html" ]; then
            echo "ERROR: dist/index.html not found"
            exit 1
          fi

          echo "Build output verified successfully"

      - name: Run Lighthouse CI
        run: npm run lighthouse:desktop
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Lighthouse output
        id: verify-lighthouse
        run: |
          if [ -d ".lighthouseci" ] && [ "$(ls -A .lighthouseci)" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Lighthouse results found:"
            ls -lh .lighthouseci/
            echo "Files count: $(ls .lighthouseci/*.html 2>/dev/null | wc -l) HTML reports"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: Lighthouse results directory is empty or missing"
          fi

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always() && steps.verify-lighthouse.outputs.exists == 'true'
        with:
          name: lighthouse-report-${{ steps.date.outputs.date }}-${{ github.sha }}
          path: frontend/.lighthouseci/
          include-hidden-files: true
          retention-days: 7

      - name: Configure Git and commit daily marker
        if: github.event_name != 'pull_request'
        working-directory: .
        run: |
          git config --local user.name "${{ secrets.GIT_USER_NAME }}"
          git config --local user.email "${{ secrets.GIT_USER_EMAIL }}"

          DATE="${{ steps.date.outputs.date }}"
          mkdir -p data/quality-checks
          echo "morning_run=$(date -u)" > "data/quality-checks/morning-${DATE}.txt"
          git add "data/quality-checks/morning-${DATE}.txt"
          git commit -m "auto: morning quality check ${DATE}" || echo "No changes to commit"

          git fetch origin master
          git pull --rebase origin master || {
            echo "Rebase failed, using merge..."
            git rebase --abort || true
            git pull origin master
          }

          git push origin HEAD:master

      - name: Comment on PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const manifestPath = path.join(
              process.env.GITHUB_WORKSPACE,
              'frontend',
              '.lighthouseci',
              'manifest.json'
            );

            let comment = '## Lighthouse CI Results\n\n';

            if (fs.existsSync(manifestPath)) {
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              comment += 'Performance tests completed successfully!\n\n';
              comment += `- Total runs: ${manifest.length}\n`;
              comment += `- Artifacts available in workflow run\n`;
            } else {
              comment += 'Lighthouse CI completed, but manifest not found. Check artifacts for details.\n';
            }

            comment += '\n---\n*Automated Lighthouse CI Report*';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Create morning report issue
        if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * *'
        uses: actions/github-script@v7
        with:
          script: |
            const date = '${{ steps.date.outputs.date }}';
            const typeCheckFailed = '${{ steps.type-check.outputs.failed }}' === 'true';
            const lintFailed = '${{ steps.lint.outputs.failed }}' === 'true';

            const typeCheckStatus = typeCheckFailed ? 'âŒ å¤±æ•—' : 'âœ… æˆåŠŸ';
            const lintStatus = lintFailed ? 'âš ï¸ è­¦å‘Šã‚ã‚Š' : 'âœ… æˆåŠŸ';

            const issueBody = `## æœã®å“è³ªãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ ${date}

            ### Lighthouse CI å®Ÿè¡Œçµæœ
            - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰: âœ… æˆåŠŸ
            - TypeScriptå‹ãƒã‚§ãƒƒã‚¯: ${typeCheckStatus}
            - ESLint: ${lintStatus}
            - Lighthouse CI: âœ… å®Ÿè¡Œå®Œäº†
            - è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã¯ [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’å‚ç…§

            ### ãƒã‚§ãƒƒã‚¯é …ç›®
            - TypeScriptå‹ãƒã‚§ãƒƒã‚¯
            - ESLintå“è³ªãƒã‚§ãƒƒã‚¯
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
            - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è©•ä¾¡
            - ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç¢ºèª

            ---
            *è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ by GitHub Actions*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[å“è³ªãƒ¬ãƒãƒ¼ãƒˆ] æœã®å®šæœŸãƒã‚§ãƒƒã‚¯ ${date}`,
              body: issueBody,
              labels: ['lighthouse', 'performance', 'automated']
            });

      - name: Notify Slack on morning check failure
        if: failure() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v2
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "ğŸš¨ æœã®å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš¨ å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:* æœã®å“è³ªãƒã‚§ãƒƒã‚¯ (Lighthouse)\n*æ—¥æ™‚:* ${{ steps.date.outputs.date }}\n*ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:* å¤±æ•—"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*å•é¡Œ:*\nâ€¢ ãƒ“ãƒ«ãƒ‰ã¾ãŸã¯ãƒ†ã‚¹ãƒˆã®å¤±æ•—\nâ€¢ å‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼\nâ€¢ Lighthouseå®Ÿè¡Œå¤±æ•—"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "è©³ç´°ã‚’ç¢ºèª"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  # ====================================================================
  # å¤œ: Data Quality & Security Check
  # ====================================================================
  evening-quality:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 12 * * *') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_type == 'evening' || github.event.inputs.job_type == 'all'))
    runs-on: ubuntu-latest
    name: Evening Quality Check (Lint, Security, Safety)

    outputs:
      date: ${{ steps.date.outputs.date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: .github/workflows/requirements-quality.txt

      - name: Install analysis tools
        run: |
          pip install -r .github/workflows/requirements-quality.txt

      - name: Run Ruff linting
        id: ruff
        continue-on-error: true
        run: |
          ruff check airflow/ scripts/ > ruff-report.txt 2>&1 || true
          if [ -f ruff-report.txt ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ruff_issues=$(wc -l < ruff-report.txt)" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ruff_issues=0" >> $GITHUB_OUTPUT
          fi

      - name: Run Bandit security scan
        id: bandit
        continue-on-error: true
        run: |
          bandit -r airflow/ scripts/ -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "bandit_issues=$(jq '.results | length' bandit-report.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "bandit_issues=0" >> $GITHUB_OUTPUT
          fi

      - name: Run Safety dependency check
        id: safety
        continue-on-error: true
        run: |
          pip freeze | safety check --json > safety-report.json || true
          if [ -f safety-report.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "safety_issues=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "safety_issues=0" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git and commit daily marker
        run: |
          git config --local user.name "${{ secrets.GIT_USER_NAME }}"
          git config --local user.email "${{ secrets.GIT_USER_EMAIL }}"

          DATE="${{ steps.date.outputs.date }}"
          mkdir -p data/quality-checks
          echo "evening_run=$(date -u)" > "data/quality-checks/evening-${DATE}.txt"
          git add "data/quality-checks/evening-${DATE}.txt"
          git commit -m "auto: evening quality check ${DATE}" || echo "No changes to commit"

          git fetch origin master
          git pull --rebase origin master || {
            echo "Rebase failed, using merge..."
            git rebase --abort || true
            git pull origin master
          }

          git push origin HEAD:master

      - name: Create evening report issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const date = '${{ steps.date.outputs.date }}';
            const ruffIssues = '${{ steps.ruff.outputs.ruff_issues }}' || '0';
            const banditIssues = '${{ steps.bandit.outputs.bandit_issues }}' || '0';
            const safetyIssues = '${{ steps.safety.outputs.safety_issues }}' || '0';

            const ruffExists = '${{ steps.ruff.outputs.exists }}' === 'true';
            const banditExists = '${{ steps.bandit.outputs.exists }}' === 'true';
            const safetyExists = '${{ steps.safety.outputs.exists }}' === 'true';

            // Status indicators
            const ruffStatus = ruffIssues === '0' ? 'âœ…' : 'âš ï¸';
            const banditStatus = banditIssues === '0' ? 'âœ…' : 'âŒ';
            const safetyStatus = safetyIssues === '0' ? 'âœ…' : 'âŒ';

            let issueBody = `## å¤œã®å“è³ªãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ ${date}

            ### ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯çµæœ
            - ${ruffStatus} **Ruff (ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«)**: ${ruffIssues} ä»¶
            - ${banditStatus} **Bandit (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)**: ${banditIssues} ä»¶
            - ${safetyStatus} **Safety (ä¾å­˜é–¢ä¿‚)**: ${safetyIssues} ä»¶

            ### ãƒã‚§ãƒƒã‚¯é …ç›®
            - âœ… Python ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«æ¤œè¨¼ (Ruff)
            - âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (Bandit)
            - âœ… ä¾å­˜é–¢ä¿‚ã®å®‰å…¨æ€§ç¢ºèª (Safety)

            `;

            // Add detailed Bandit findings if available
            if (banditExists) {
              try {
                const banditReport = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
                if (banditReport.results && banditReport.results.length > 0) {
                  issueBody += `\n### ğŸ”’ Bandit ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œå‡ºé …ç›® (ä¸Šä½5ä»¶)\n\n`;
                  banditReport.results.slice(0, 5).forEach((issue, idx) => {
                    issueBody += `${idx + 1}. **${issue.issue_severity}** - ${issue.issue_text}\n`;
                    issueBody += `   - ãƒ•ã‚¡ã‚¤ãƒ«: \`${issue.filename}:${issue.line_number}\`\n`;
                    issueBody += `   - ä¿¡é ¼åº¦: ${issue.issue_confidence}\n\n`;
                  });
                }
              } catch (e) {
                console.log('Failed to parse bandit report:', e);
              }
            }

            // Add detailed Safety findings if available
            if (safetyExists) {
              try {
                const safetyReport = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
                if (safetyReport.vulnerabilities && safetyReport.vulnerabilities.length > 0) {
                  issueBody += `\n### ğŸ” Safety è„†å¼±æ€§æ¤œå‡ºé …ç›® (ä¸Šä½5ä»¶)\n\n`;
                  safetyReport.vulnerabilities.slice(0, 5).forEach((vuln, idx) => {
                    issueBody += `${idx + 1}. **${vuln.package_name}** (${vuln.vulnerable_spec})\n`;
                    issueBody += `   - CVE: ${vuln.vulnerability_id}\n`;
                    issueBody += `   - è©³ç´°: ${vuln.advisory}\n\n`;
                  });
                }
              } catch (e) {
                console.log('Failed to parse safety report:', e);
              }
            }

            issueBody += `\nè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã¯ [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’å‚ç…§

            ---
            *è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ by GitHub Actions*`;

            const labels = ['quality', 'security', 'automated', 'evening-check'];

            // Add severity labels based on findings
            if (parseInt(banditIssues) > 0) labels.push('security-issues');
            if (parseInt(safetyIssues) > 0) labels.push('vulnerability');
            if (parseInt(ruffIssues) > 10) labels.push('code-quality');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[å“è³ªãƒ¬ãƒãƒ¼ãƒˆ] å¤œã®å®šæœŸãƒã‚§ãƒƒã‚¯ ${date}`,
              body: issueBody,
              labels: labels
            });

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports-${{ steps.date.outputs.date }}-${{ github.sha }}
          path: |
            ruff-report.txt
            bandit-report.json
            safety-report.json
          if-no-files-found: warn
          retention-days: 30

      - name: Notify Slack on security issues
        if: |
          github.event_name == 'schedule' &&
          (steps.bandit.outputs.bandit_issues > 0 || steps.safety.outputs.safety_issues > 0)
        uses: slackapi/slack-github-action@v2
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:* å¤œã®å“è³ªãƒã‚§ãƒƒã‚¯ (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)\n*æ—¥æ™‚:* ${{ steps.date.outputs.date }}\n*ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œæ¤œå‡º"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Bandit:*\n${{ steps.bandit.outputs.bandit_issues }} ä»¶"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Safety:*\n${{ steps.safety.outputs.safety_issues }} ä»¶"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*å„ªå…ˆåº¦:* ğŸ”´ è¦å¯¾å¿œ"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Notify Slack on evening check failure
        if: failure() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v2
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "ğŸš¨ å¤œã®å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš¨ å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:* å¤œã®å“è³ªãƒã‚§ãƒƒã‚¯ (Python)\n*æ—¥æ™‚:* ${{ steps.date.outputs.date }}\n*ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:* å¤±æ•—"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*å•é¡Œ:*\nâ€¢ åˆ†æãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—\nâ€¢ ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œã‚¨ãƒ©ãƒ¼\nâ€¢ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå¤±æ•—"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "è©³ç´°ã‚’ç¢ºèª"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
