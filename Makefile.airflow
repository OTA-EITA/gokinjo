# Airflow ETL ä¾¿åˆ©ã‚³ãƒãƒ³ãƒ‰é›†

# DAGä¸€è¦§ï¼ˆè©³ç´°ç‰ˆï¼‰
.PHONY: airflow-list-dags
airflow-list-dags: ## DAGè©³ç´°ãƒªã‚¹ãƒˆè¡¨ç¤º
	@echo "ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªDAGä¸€è¦§:"
	cd airflow && docker-compose -f docker-compose.airflow.yml exec airflow-webserver airflow dags list

# DAGæ‰‹å‹•å®Ÿè¡Œï¼ˆæ±ç”¨ç‰ˆï¼‰
.PHONY: airflow-run-dag
airflow-run-dag: ## æŒ‡å®šDAGã‚’æ‰‹å‹•å®Ÿè¡Œ (make airflow-run-dag DAG_ID=dag_name)
	@echo "ğŸš€ DAGå®Ÿè¡Œ: $(DAG_ID)"
	cd airflow && docker-compose -f docker-compose.airflow.yml exec airflow-webserver airflow dags trigger $(DAG_ID)

# DAGå®Ÿè¡Œå±¥æ­´ç¢ºèª
.PHONY: airflow-runs
airflow-runs: ## DAGå®Ÿè¡Œå±¥æ­´è¡¨ç¤º
	@echo "ğŸ“Š DAGå®Ÿè¡Œå±¥æ­´:"
	cd airflow && docker-compose -f docker-compose.airflow.yml exec airflow-webserver airflow dags list-runs

# Airflowå†èµ·å‹•
.PHONY: airflow-restart
airflow-restart: airflow-stop airflow-start ## Airflowç’°å¢ƒå†èµ·å‹•

# ãƒ†ã‚¹ãƒˆDAGå®Ÿè¡Œ
.PHONY: test-dag
test-dag: ## ãƒ†ã‚¹ãƒˆç”¨DAGå®Ÿè¡Œ
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆDAGå®Ÿè¡Œä¸­..."
	cd airflow && docker-compose -f docker-compose.airflow.yml exec airflow-webserver airflow dags trigger test_crime_etl

# çŠ¯ç½ªETL DAGå®Ÿè¡Œ
.PHONY: crime-etl
crime-etl: ## çŠ¯ç½ªETL DAGå®Ÿè¡Œ
	@echo "ğŸš¨ çŠ¯ç½ªETLå®Ÿè¡Œä¸­..."
	cd airflow && docker-compose -f docker-compose.airflow.yml exec airflow-webserver airflow dags trigger tokyo_crime_etl

# å­¦æ ¡ETL DAGå®Ÿè¡Œ  
.PHONY: school-etl
school-etl: ## å­¦æ ¡ETL DAGå®Ÿè¡Œ
	@echo "ğŸ« å­¦æ ¡ETLå®Ÿè¡Œä¸­..."
	cd airflow && docker-compose -f docker-compose.airflow.yml exec airflow-webserver airflow dags trigger tokyo_school_etl

# DAGçŠ¶æ…‹è©³ç´°ç¢ºèª
.PHONY: airflow-check
airflow-check: ## å…¨DAGçŠ¶æ…‹è©³ç´°ç¢ºèª
	@echo "ğŸ” DAGçŠ¶æ…‹ç¢ºèª:"
	cd airflow && docker-compose -f docker-compose.airflow.yml exec airflow-webserver airflow dags list
	@echo ""
	@echo "æœ€è¿‘ã®å®Ÿè¡Œå±¥æ­´:"
	cd airflow && docker-compose -f docker-compose.airflow.yml exec airflow-webserver airflow dags list-runs --limit 10

# Airflowã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
.PHONY: airflow-clean
airflow-clean: ## Airflowå®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ§¹ Airflowã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."
	cd airflow && docker-compose -f docker-compose.airflow.yml down -v --remove-orphans
	rm -rf airflow/{logs,plugins/__pycache__}
	@echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# Web UIé–‹ã
.PHONY: airflow-ui
airflow-ui: ## Airflow Web UIã‚’é–‹ã
	@echo "ğŸŒ Airflow Web UIã‚’é–‹ã„ã¦ã„ã¾ã™..."
	open http://localhost:8082
	@echo "ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±: admin / admin"
