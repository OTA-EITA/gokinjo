"""
Notification Functions

è¨­è¨ˆæ›¸ã«åŸºã¥ãåˆ†é›¢DAGå¯¾å¿œã®é€šçŸ¥æ©Ÿèƒ½ï¼š
- çŠ¯ç½ªETLå®Œäº†é€šçŸ¥ï¼šæœˆæ¬¡å®Ÿè¡Œçµæœãƒ¬ãƒãƒ¼ãƒˆ
- å­¦æ ¡ETLå®Œäº†é€šçŸ¥ï¼šå¹´æ¬¡å®Ÿè¡Œçµæœãƒ¬ãƒãƒ¼ãƒˆ
- ã‚¨ãƒ©ãƒ¼é€šçŸ¥ï¼šDAGåˆ¥ã®ã‚¨ãƒ©ãƒ¼å ±å‘Š
"""

import logging
from typing import Dict, List
from datetime import datetime
from tokyo_etl.utils.task_logging import (
    log_task_start,
    log_task_complete,
)
from tokyo_etl.utils.task_results import get_task_result


def send_crime_completion_notification_task(**context) -> None:
    """
    çŠ¯ç½ªETLå®Œäº†é€šçŸ¥ï¼ˆçŠ¯ç½ªDAGå°‚ç”¨ï¼‰

    çŠ¯ç½ªãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¨å®‰å…¨ã‚¹ã‚³ã‚¢å†è¨ˆç®—ã®å®Œäº†ã‚’é€šçŸ¥ã—ã¾ã™ã€‚
    """
    log_task_start("crime_completion_notification", **context)

    try:
        # å‰ã‚¿ã‚¹ã‚¯ã®çµæœå–å¾—
        load_stats = get_task_result(
            context["task_instance"], "load_crime_to_postgis", "load_stats"
        )
        safety_result = get_task_result(
            context["task_instance"], "recalculate_safety_scores", "safety_calculation"
        )

        # çŠ¯ç½ªETLå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
        report = create_crime_completion_report(
            context["ds"], context["dag_run"].run_id, load_stats, safety_result
        )

        # é€šçŸ¥é€ä¿¡
        send_crime_notification(report)

        log_task_complete(
            "crime_completion_notification", report_size=len(report), **context
        )

    except Exception as e:
        log_error_notification("crime_completion_notification", str(e))
        raise


def send_school_completion_notification_task(**context) -> None:
    """
    å­¦æ ¡ETLå®Œäº†é€šçŸ¥ï¼ˆå­¦æ ¡DAGå°‚ç”¨ï¼‰

    å­¦æ ¡ãƒ‡ãƒ¼ã‚¿åŒæœŸã¨çµ±å»ƒåˆå‡¦ç†ã®å®Œäº†ã‚’é€šçŸ¥ã—ã¾ã™ã€‚
    """
    log_task_start("school_completion_notification", **context)

    try:
        # å‰ã‚¿ã‚¹ã‚¯ã®çµæœå–å¾—
        sync_result = get_task_result(
            context["task_instance"], "sync_school_to_postgis", "sync_result"
        )

        # å­¦æ ¡ETLå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
        report = create_school_completion_report(
            context["ds"], context["dag_run"].run_id, sync_result
        )

        # é€šçŸ¥é€ä¿¡
        send_school_notification(report)

        log_task_complete(
            "school_completion_notification", report_size=len(report), **context
        )

    except Exception as e:
        log_error_notification("school_completion_notification", str(e))
        raise


def create_crime_completion_report(
    execution_date: str, dag_run_id: str, load_stats: Dict, safety_result: Dict
) -> str:
    """
    çŠ¯ç½ªETLå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
    """
    report = f"""
ğŸš¨ Tokyo Crime Data ETL Pipeline Complete!

ğŸ“… Execution Details:
â€¢ Execution Date: {execution_date}
â€¢ DAG Run ID: {dag_run_id}
â€¢ Completion Time: {datetime.now().isoformat()}

ğŸ“Š Crime Data Statistics:
â€¢ New Crime Records: {load_stats.get("inserted", 0)}
â€¢ Updated Records: {load_stats.get("updated", 0)}
â€¢ Total Crimes in DB: {load_stats.get("total_crimes", "N/A")}
â€¢ Covered Wards: {load_stats.get("covered_wards", "N/A")}
â€¢ Crime Types: {load_stats.get("crime_types", "N/A")}
â€¢ Data Period: {load_stats.get("earliest_crime", "N/A")} ~ {load_stats.get("latest_crime", "N/A")}

ğŸ« Safety Score Update:
â€¢ Schools Updated: {safety_result.get("updated_schools", 0)}
â€¢ Average Safety Score: {safety_result.get("average_score", "N/A"):.1f}
â€¢ Very Safe Schools (90+): {safety_result.get("score_distribution", {}).get("very_safe_count", 0)}
â€¢ Safe Schools (70-89): {safety_result.get("score_distribution", {}).get("safe_count", 0)}
â€¢ Moderate Schools (50-69): {safety_result.get("score_distribution", {}).get("moderate_count", 0)}
â€¢ Caution Schools (<50): {safety_result.get("score_distribution", {}).get("caution_count", 0)}

âœ… Monthly Crime ETL Status: SUCCESSFUL
â€¢ Data Download: Complete
â€¢ Data Transformation: Complete  
â€¢ PostGIS Loading: Complete
â€¢ Safety Score Recalculation: Complete

ğŸ¯ Next Crime ETL: {get_next_crime_execution_date(execution_date)}

---
Generated by Tokyo Crime ETL Pipeline (Monthly)
    """

    return report.strip()


def create_school_completion_report(
    execution_date: str, dag_run_id: str, sync_result: Dict
) -> str:
    """
    å­¦æ ¡ETLå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
    """
    report = f"""
ğŸ« Tokyo School Data ETL Pipeline Complete!

ğŸ“… Execution Details:
â€¢ Execution Date: {execution_date}
â€¢ DAG Run ID: {dag_run_id}
â€¢ Completion Time: {datetime.now().isoformat()}

ğŸ“Š School Data Statistics:
â€¢ New Schools Added: {sync_result.get("new_count", 0)}
â€¢ Schools Updated: {sync_result.get("updated_count", 0)}
â€¢ Schools Closed: {sync_result.get("closed_count", 0)}
â€¢ Total Active Schools: {sync_result.get("active_schools", "N/A")}
â€¢ Covered Wards: {sync_result.get("covered_wards", "N/A")}

ğŸ›ï¸ School Breakdown:
â€¢ Elementary Schools: {sync_result.get("elementary_count", 0)}
â€¢ Junior High Schools: {sync_result.get("junior_high_count", 0)}
â€¢ High Schools: {sync_result.get("high_count", 0)}
â€¢ Average Safety Score: {sync_result.get("avg_safety_score", "N/A")}

ğŸ”„ Sync Operations:
â€¢ New School Safety Scores Initialized: {len(sync_result.get("new_schools", []))}
â€¢ School Consolidations Processed: {sync_result.get("closed_count", 0)}

âœ… Annual School ETL Status: SUCCESSFUL
â€¢ Data Download: Complete
â€¢ Data Transformation: Complete
â€¢ PostGIS Synchronization: Complete
â€¢ Safety Score Initialization: Complete

ğŸ¯ Next School ETL: {get_next_school_execution_date(execution_date)}

---
Generated by Tokyo School ETL Pipeline (Annual)
    """

    return report.strip()


def create_completion_report(
    execution_date: str, dag_run_id: str, load_summary: Dict, safety_scores: List[Dict]
) -> str:
    """ETLå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆï¼ˆå¾“æ¥ç‰ˆãƒ»äº’æ›æ€§ç¶­æŒï¼‰"""
    report = f"""
Tokyo Crime & School ETL Pipeline Complete!

Execution Details:
â€¢ Execution Date: {execution_date}
â€¢ DAG Run ID: {dag_run_id}
â€¢ Completion Time: {datetime.now().isoformat()}

Database Statistics:
â€¢ Total Areas: {load_summary.get("total_areas", "N/A")}
â€¢ Total Schools: {load_summary.get("total_schools", "N/A")}
â€¢ Total Crimes: {load_summary.get("total_crimes", "N/A")}
â€¢ Priority 2 Areas Added: {load_summary.get("priority_2_areas", "N/A")}

Safety Scores:
â€¢ Schools Processed: {len(safety_scores) if safety_scores else 0}

Phase 2 Status: SUCCESSFUL
â€¢ å°æ±åŒºãƒ‡ãƒ¼ã‚¿: Complete
â€¢ æ–‡äº¬åŒºãƒ‡ãƒ¼ã‚¿: Complete

Next Steps:
1. Test frontend with new data
2. Verify API endpoints  
3. Check map display for å°æ±åŒºãƒ»æ–‡äº¬åŒº
4. Ready for Priority 3 expansion

---
Generated by Tokyo Crime & School ETL Pipeline
    """

    return report.strip()


def send_crime_notification(report: str) -> Dict:
    """
    çŠ¯ç½ªETLé€šçŸ¥é€ä¿¡
    """
    # ãƒ­ã‚°å‡ºåŠ›
    log_completion_report(report, "CRIME ETL")

    # å°†æ¥çš„ã«ã¯Slack/Emailé€šçŸ¥ã«æ‹¡å¼µ
    # slack_notification(report, channel="#crime-data")
    # email_notification(report, subject="Crime ETL Complete")

    return {
        "status": "sent",
        "notification_time": datetime.now().isoformat(),
        "report_length": len(report),
        "recipients": ["log"],  # å°†æ¥ã¯ ['log', 'slack', 'email']
        "notification_type": "crime_etl_completion",
    }


def send_school_notification(report: str) -> Dict:
    """
    å­¦æ ¡ETLé€šçŸ¥é€ä¿¡
    """
    # ãƒ­ã‚°å‡ºåŠ›
    log_completion_report(report, "SCHOOL ETL")

    # å°†æ¥çš„ã«ã¯Slack/Emailé€šçŸ¥ã«æ‹¡å¼µ
    # slack_notification(report, channel="#school-data")
    # email_notification(report, subject="School ETL Complete")

    return {
        "status": "sent",
        "notification_time": datetime.now().isoformat(),
        "report_length": len(report),
        "recipients": ["log"],  # å°†æ¥ã¯ ['log', 'slack', 'email']
        "notification_type": "school_etl_completion",
    }


def log_completion_report(report: str, report_type: str = "ETL") -> None:
    """å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ­ã‚°å‡ºåŠ›"""
    logging.info(f"{report_type} Completion Report:")
    for line in report.split("\n"):
        if line.strip():
            logging.info(line)


def send_completion_notification(
    execution_date: str, dag_run_id: str, load_summary: Dict, safety_scores: List[Dict]
) -> Dict:
    """ETLå®Œäº†é€šçŸ¥é€ä¿¡ï¼ˆå¾“æ¥ç‰ˆãƒ»äº’æ›æ€§ç¶­æŒï¼‰"""
    # ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
    report = create_completion_report(
        execution_date, dag_run_id, load_summary, safety_scores
    )

    # ãƒ­ã‚°å‡ºåŠ›
    log_completion_report(report)

    # å°†æ¥çš„ã«ã¯Slack/Emailé€šçŸ¥ã«æ‹¡å¼µ
    # slack_notification(report)
    # email_notification(report)

    return {
        "status": "sent",
        "notification_time": datetime.now().isoformat(),
        "report_length": len(report),
        "recipients": ["log"],  # å°†æ¥ã¯ ['log', 'slack', 'email']
    }


def get_next_crime_execution_date(current_date: str) -> str:
    """
    æ¬¡å›çŠ¯ç½ªETLå®Ÿè¡Œæ—¥å–å¾—
    """
    from dateutil.relativedelta import relativedelta
    from datetime import datetime

    current = datetime.fromisoformat(current_date)
    next_execution = current.replace(day=5) + relativedelta(months=1)

    return next_execution.strftime("%Y-%m-%d (Monthly)")


def get_next_school_execution_date(current_date: str) -> str:
    """
    æ¬¡å›å­¦æ ¡ETLå®Ÿè¡Œæ—¥å–å¾—
    """
    from dateutil.relativedelta import relativedelta
    from datetime import datetime

    current = datetime.fromisoformat(current_date)
    next_execution = current.replace(month=4, day=5) + relativedelta(years=1)

    return next_execution.strftime("%Y-%m-%d (Annual)")


def log_error_notification(task_name: str, error_msg: str) -> None:
    """ã‚¨ãƒ©ãƒ¼é€šçŸ¥"""
    error_report = f"""
ETL Pipeline Error in {task_name}

Error Details:
{error_msg}

Error Time: {datetime.now().isoformat()}

Recommended Actions:
1. Check Airflow logs for detailed error trace
2. Verify database connectivity
3. Check file system permissions
4. Validate input data integrity
    """

    logging.error("ETL Error Report:")
    for line in error_report.split("\n"):
        if line.strip():
            logging.error(line)
